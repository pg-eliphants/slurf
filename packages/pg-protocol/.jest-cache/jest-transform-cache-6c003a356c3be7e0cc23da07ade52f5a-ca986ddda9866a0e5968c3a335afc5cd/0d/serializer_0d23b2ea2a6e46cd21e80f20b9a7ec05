7436eee3f2812d8b8a07381acf10e236
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.serialize = void 0;
const buffer_writer_1 = require("./buffer-writer");
var code;
(function (code) {
    code[code["startup"] = 112] = "startup";
    code[code["query"] = 81] = "query";
    code[code["parse"] = 80] = "parse";
    code[code["bind"] = 66] = "bind";
    code[code["execute"] = 69] = "execute";
    code[code["flush"] = 72] = "flush";
    code[code["sync"] = 83] = "sync";
    code[code["end"] = 88] = "end";
    code[code["close"] = 67] = "close";
    code[code["describe"] = 68] = "describe";
    code[code["copyFromChunk"] = 100] = "copyFromChunk";
    code[code["copyDone"] = 99] = "copyDone";
    code[code["copyFail"] = 102] = "copyFail";
})(code || (code = {}));
const writer = new buffer_writer_1.Writer();
const startup = (opts) => {
    // protocol version
    writer.addInt16(3).addInt16(0);
    for (const key of Object.keys(opts)) {
        writer.addCString(key).addCString(opts[key]);
    }
    writer.addCString('client_encoding').addCString('UTF8');
    var bodyBuffer = writer.addCString('').flush();
    // this message is sent without a code
    var length = bodyBuffer.length + 4;
    return new buffer_writer_1.Writer().addInt32(length).add(bodyBuffer).flush();
};
const requestSsl = () => {
    const response = Buffer.allocUnsafe(8);
    response.writeInt32BE(8, 0);
    response.writeInt32BE(80877103, 4);
    return response;
};
const password = (password) => {
    return writer.addCString(password).flush(112 /* startup */);
};
const sendSASLInitialResponseMessage = function (mechanism, initialResponse) {
    // 0x70 = 'p'
    writer.addCString(mechanism).addInt32(Buffer.byteLength(initialResponse)).addString(initialResponse);
    return writer.flush(112 /* startup */);
};
const sendSCRAMClientFinalMessage = function (additionalData) {
    return writer.addString(additionalData).flush(112 /* startup */);
};
const query = (text) => {
    return writer.addCString(text).flush(81 /* query */);
};
const emptyArray = [];
const parse = (query) => {
    // expect something like this:
    // { name: 'queryName',
    //   text: 'select * from blah',
    //   types: ['int8', 'bool'] }
    // normalize missing query names to allow for null
    const name = query.name || '';
    if (name.length > 63) {
        /* eslint-disable no-console */
        console.error('Warning! Postgres only supports 63 characters for query names.');
        console.error('You supplied %s (%s)', name, name.length);
        console.error('This can cause conflicts and silent errors executing queries');
        /* eslint-enable no-console */
    }
    const types = query.types || emptyArray;
    var len = types.length;
    var buffer = writer
        .addCString(name) // name of query
        .addCString(query.text) // actual query text
        .addInt16(len);
    for (var i = 0; i < len; i++) {
        buffer.addInt32(types[i]);
    }
    return writer.flush(80 /* parse */);
};
const paramWriter = new buffer_writer_1.Writer();
// make this a const enum so typescript will inline the value
var ParamType;
(function (ParamType) {
    ParamType[ParamType["STRING"] = 0] = "STRING";
    ParamType[ParamType["BINARY"] = 1] = "BINARY";
})(ParamType || (ParamType = {}));
const writeValues = function (values, valueMapper) {
    for (let i = 0; i < values.length; i++) {
        const mappedVal = valueMapper ? valueMapper(values[i], i) : values[i];
        if (mappedVal == null) {
            // add the param type (string) to the writer
            writer.addInt16(0 /* STRING */);
            // write -1 to the param writer to indicate null
            paramWriter.addInt32(-1);
        }
        else if (mappedVal instanceof Buffer) {
            // add the param type (binary) to the writer
            writer.addInt16(1 /* BINARY */);
            // add the buffer to the param writer
            paramWriter.addInt32(mappedVal.length);
            paramWriter.add(mappedVal);
        }
        else {
            // add the param type (string) to the writer
            writer.addInt16(0 /* STRING */);
            paramWriter.addInt32(Buffer.byteLength(mappedVal));
            paramWriter.addString(mappedVal);
        }
    }
};
const bind = (config = {}) => {
    // normalize config
    const portal = config.portal || '';
    const statement = config.statement || '';
    const binary = config.binary || false;
    const values = config.values || emptyArray;
    const len = values.length;
    writer.addCString(portal).addCString(statement);
    writer.addInt16(len);
    writeValues(values, config.valueMapper);
    writer.addInt16(len);
    writer.add(paramWriter.flush());
    // format code
    writer.addInt16(binary ? 1 /* BINARY */ : 0 /* STRING */);
    return writer.flush(66 /* bind */);
};
const emptyExecute = Buffer.from([69 /* execute */, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00]);
const execute = (config) => {
    // this is the happy path for most queries
    if (!config || (!config.portal && !config.rows)) {
        return emptyExecute;
    }
    const portal = config.portal || '';
    const rows = config.rows || 0;
    const portalLength = Buffer.byteLength(portal);
    const len = 4 + portalLength + 1 + 4;
    // one extra bit for code
    const buff = Buffer.allocUnsafe(1 + len);
    buff[0] = 69 /* execute */;
    buff.writeInt32BE(len, 1);
    buff.write(portal, 5, 'utf-8');
    buff[portalLength + 5] = 0; // null terminate portal cString
    buff.writeUInt32BE(rows, buff.length - 4);
    return buff;
};
const cancel = (processID, secretKey) => {
    const buffer = Buffer.allocUnsafe(16);
    buffer.writeInt32BE(16, 0);
    buffer.writeInt16BE(1234, 4);
    buffer.writeInt16BE(5678, 6);
    buffer.writeInt32BE(processID, 8);
    buffer.writeInt32BE(secretKey, 12);
    return buffer;
};
const cstringMessage = (code, string) => {
    const stringLen = Buffer.byteLength(string);
    const len = 4 + stringLen + 1;
    // one extra bit for code
    const buffer = Buffer.allocUnsafe(1 + len);
    buffer[0] = code;
    buffer.writeInt32BE(len, 1);
    buffer.write(string, 5, 'utf-8');
    buffer[len] = 0; // null terminate cString
    return buffer;
};
const emptyDescribePortal = writer.addCString('P').flush(68 /* describe */);
const emptyDescribeStatement = writer.addCString('S').flush(68 /* describe */);
const describe = (msg) => {
    return msg.name
        ? cstringMessage(68 /* describe */, `${msg.type}${msg.name || ''}`)
        : msg.type === 'P'
            ? emptyDescribePortal
            : emptyDescribeStatement;
};
const close = (msg) => {
    const text = `${msg.type}${msg.name || ''}`;
    return cstringMessage(67 /* close */, text);
};
const copyData = (chunk) => {
    return writer.add(chunk).flush(100 /* copyFromChunk */);
};
const copyFail = (message) => {
    return cstringMessage(102 /* copyFail */, message);
};
const codeOnlyBuffer = (code) => Buffer.from([code, 0x00, 0x00, 0x00, 0x04]);
const flushBuffer = codeOnlyBuffer(72 /* flush */);
const syncBuffer = codeOnlyBuffer(83 /* sync */);
const endBuffer = codeOnlyBuffer(88 /* end */);
const copyDoneBuffer = codeOnlyBuffer(99 /* copyDone */);
const serialize = {
    startup,
    password,
    requestSsl,
    sendSASLInitialResponseMessage,
    sendSCRAMClientFinalMessage,
    query,
    parse,
    bind,
    execute,
    describe,
    close,
    flush: () => flushBuffer,
    sync: () => syncBuffer,
    end: () => endBuffer,
    copyData,
    copyDone: () => copyDoneBuffer,
    copyFail,
    cancel
};
exports.serialize = serialize;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXHJlcG9zXFxub2RlLXBvc3RncmVzXFxwYWNrYWdlc1xccGctcHJvdG9jb2xcXHNyY1xcc2VyaWFsaXplci50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxtREFBeUM7QUFFekMsSUFBVyxJQWNWO0FBZEQsV0FBVyxJQUFJO0lBQ1gsdUNBQWMsQ0FBQTtJQUNkLGtDQUFZLENBQUE7SUFDWixrQ0FBWSxDQUFBO0lBQ1osZ0NBQVcsQ0FBQTtJQUNYLHNDQUFjLENBQUE7SUFDZCxrQ0FBWSxDQUFBO0lBQ1osZ0NBQVcsQ0FBQTtJQUNYLDhCQUFVLENBQUE7SUFDVixrQ0FBWSxDQUFBO0lBQ1osd0NBQWUsQ0FBQTtJQUNmLG1EQUFvQixDQUFBO0lBQ3BCLHdDQUFlLENBQUE7SUFDZix5Q0FBZSxDQUFBO0FBQ25CLENBQUMsRUFkVSxJQUFJLEtBQUosSUFBSSxRQWNkO0FBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxzQkFBTSxFQUFFLENBQUM7QUFFNUIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUE0QixFQUFVLEVBQUU7SUFDckQsbUJBQW1CO0lBQ25CLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQy9CLEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNqQyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztLQUNoRDtJQUVELE1BQU0sQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFeEQsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMvQyxzQ0FBc0M7SUFFdEMsSUFBSSxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFFbkMs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MkI7SUFDM0IsS0FBSztJQUNMLEtBQUs7SUFDTCxJQUFJO0lBQ0osT0FBTztJQUNQLFFBQVE7SUFDUixLQUFLO0lBQ0wsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDLFdBQVc7SUFDeEIsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLFVBQVU7SUFDdEIsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLFNBQVM7SUFDcEIsUUFBUTtJQUNSLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxjQUFjO0lBQzlCLFFBQVE7SUFDUixNQUFNO0NBQ1QsQ0FBQztBQUVPLDhCQUFTIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxyZXBvc1xcbm9kZS1wb3N0Z3Jlc1xccGFja2FnZXNcXHBnLXByb3RvY29sXFxzcmNcXHNlcmlhbGl6ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV3JpdGVyIH0gZnJvbSAnLi9idWZmZXItd3JpdGVyJztcblxuY29uc3QgZW51bSBjb2RlIHtcbiAgICBzdGFydHVwID0gMHg3MCxcbiAgICBxdWVyeSA9IDB4NTEsXG4gICAgcGFyc2UgPSAweDUwLFxuICAgIGJpbmQgPSAweDQyLFxuICAgIGV4ZWN1dGUgPSAweDQ1LFxuICAgIGZsdXNoID0gMHg0OCxcbiAgICBzeW5jID0gMHg1MyxcbiAgICBlbmQgPSAweDU4LFxuICAgIGNsb3NlID0gMHg0MyxcbiAgICBkZXNjcmliZSA9IDB4NDQsXG4gICAgY29weUZyb21DaHVuayA9IDB4NjQsXG4gICAgY29weURvbmUgPSAweDYzLFxuICAgIGNvcHlGYWlsID0gMHg2NlxufVxuXG5jb25zdCB3cml0ZXIgPSBuZXcgV3JpdGVyKCk7XG5cbmNvbnN0IHN0YXJ0dXAgPSAob3B0czogUmVjb3JkPHN0cmluZywgc3RyaW5nPik6IEJ1ZmZlciA9PiB7XG4gICAgLy8gcHJvdG9jb2wgdmVyc2lvblxuICAgIHdyaXRlci5hZGRJbnQxNigzKS5hZGRJbnQxNigwKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhvcHRzKSkge1xuICAgICAgICB3cml0ZXIuYWRkQ1N0cmluZyhrZXkpLmFkZENTdHJpbmcob3B0c1trZXldKTtcbiAgICB9XG5cbiAgICB3cml0ZXIuYWRkQ1N0cmluZygnY2xpZW50X2VuY29kaW5nJykuYWRkQ1N0cmluZygnVVRGOCcpO1xuXG4gICAgdmFyIGJvZHlCdWZmZXIgPSB3cml0ZXIuYWRkQ1N0cmluZygnJykuZmx1c2goKTtcbiAgICAvLyB0aGlzIG1lc3NhZ2UgaXMgc2VudCB3aXRob3V0IGEgY29kZVxuXG4gICAgdmFyIGxlbmd0aCA9IGJvZHlCdWZmZXIubGVuZ3RoICsgNDtcblxuICAgIHJldHVybiBuZXcgV3JpdGVyKCkuYWRkSW50MzIobGVuZ3RoKS5hZGQoYm9keUJ1ZmZlcikuZmx1c2goKTtcbn07XG5cbmNvbnN0IHJlcXVlc3RTc2wgPSAoKTogQnVmZmVyID0+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSg4KTtcbiAgICByZXNwb25zZS53cml0ZUludDMyQkUoOCwgMCk7XG4gICAgcmVzcG9uc2Uud3JpdGVJbnQzMkJFKDgwODc3MTAzLCA0KTtcbiAgICByZXR1cm4gcmVzcG9uc2U7XG59O1xuXG5jb25zdCBwYXNzd29yZCA9IChwYXNzd29yZDogc3RyaW5nKTogQnVmZmVyID0+IHtcbiAgICByZXR1cm4gd3JpdGVyLmFkZENTdHJpbmcocGFzc3dvcmQpLmZsdXNoKGNvZGUuc3RhcnR1cCk7XG59O1xuXG5jb25zdCBzZW5kU0FTTEluaXRpYWxSZXNwb25zZU1lc3NhZ2UgPSBmdW5jdGlvbiAobWVjaGFuaXNtOiBzdHJpbmcsIGluaXRpYWxSZXNwb25zZTogc3RyaW5nKTogQnVmZmVyIHtcbiAgICAvLyAweDcwID0gJ3AnXG4gICAgd3JpdGVyLmFkZENTdHJpbmcobWVjaGFuaXNtKS5hZGRJbnQzMihCdWZmZXIuYnl0ZUxlbmd0aChpbml0aWFsUmVzcG9uc2UpKS5hZGRTdHJpbmcoaW5pdGlhbFJlc3BvbnNlKTtcblxuICAgIHJldHVybiB3cml0ZXIuZmx1c2goY29kZS5zdGFydHVwKTtcbn07XG5cbmNvbnN0IHNlbmRTQ1JBTUNsaWVudEZpbmFsTWVzc2FnZSA9IGZ1bmN0aW9uIChhZGRpdGlvbmFsRGF0YTogc3RyaW5nKTogQnVmZmVyIHtcbiAgICByZXR1cm4gd3JpdGVyLmFkZFN0cmluZyhhZGRpdGlvbmFsRGF0YSkuZmx1c2goY29kZS5zdGFydHVwKTtcbn07XG5cbmNvbnN0IHF1ZXJ5ID0gKHRleHQ6IHN0cmluZyk6IEJ1ZmZlciA9PiB7XG4gICAgcmV0dXJuIHdyaXRlci5hZGRDU3RyaW5nKHRleHQpLmZsdXNoKGNvZGUucXVlcnkpO1xufTtcblxudHlwZSBQYXJzZU9wdHMgPSB7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICB0eXBlcz86IG51bWJlcltdO1xuICAgIHRleHQ6IHN0cmluZztcbn07XG5cbmNvbnN0IGVtcHR5QXJyYXk6IGFueVtdID0gW107XG5cbmNvbnN0IHBhcnNlID0gKHF1ZXJ5OiBQYXJzZU9wdHMpOiBCdWZmZXIgPT4ge1xuICAgIC8vIGV4cGVjdCBzb21ldGhpbmcgbGlrZSB0aGlzOlxuICAgIC8vIHsgbmFtZTogJ3F1ZXJ5TmFtZScsXG4gICAgLy8gICB0ZXh0OiAnc2VsZWN0ICogZnJvbSBibGFoJyxcbiAgICAvLyAgIHR5cGVzOiBbJ2ludDgnLCAnYm9vbCddIH1cblxuICAgIC8vIG5vcm1hbGl6ZSBtaXNzaW5nIHF1ZXJ5IG5hbWVzIHRvIGFsbG93IGZvciBudWxsXG4gICAgY29uc3QgbmFtZSA9IHF1ZXJ5Lm5hbWUgfHwgJyc7XG4gICAgaWYgKG5hbWUubGVuZ3RoID4gNjMpIHtcbiAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqL1xuICAgICAgICBjb25zb2xlLmVycm9yKCdXYXJuaW5nISBQb3N0Z3JlcyBvbmx5IHN1cHBvcnRzIDYzIGNoYXJhY3RlcnMgZm9yIHF1ZXJ5IG5hbWVzLicpO1xuICAgICAgICBjb25zb2xlLmVycm9yKCdZb3Ugc3VwcGxpZWQgJXMgKCVzKScsIG5hbWUsIG5hbWUubGVuZ3RoKTtcbiAgICAgICAgY29uc29sZS5lcnJvcignVGhpcyBjYW4gY2F1c2UgY29uZmxpY3RzIGFuZCBzaWxlbnQgZXJyb3JzIGV4ZWN1dGluZyBxdWVyaWVzJyk7XG4gICAgICAgIC8qIGVzbGludC1lbmFibGUgbm8tY29uc29sZSAqL1xuICAgIH1cblxuICAgIGNvbnN0IHR5cGVzID0gcXVlcnkudHlwZXMgfHwgZW1wdHlBcnJheTtcblxuICAgIHZhciBsZW4gPSB0eXBlcy5sZW5ndGg7XG5cbiAgICB2YXIgYnVmZmVyID0gd3JpdGVyXG4gICAgICAgIC5hZGRDU3RyaW5nKG5hbWUpIC8vIG5hbWUgb2YgcXVlcnlcbiAgICAgICAgLmFkZENTdHJpbmcocXVlcnkudGV4dCkgLy8gYWN0dWFsIHF1ZXJ5IHRleHRcbiAgICAgICAgLmFkZEludDE2KGxlbik7XG5cbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgIGJ1ZmZlci5hZGRJbnQzMih0eXBlc1tpXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHdyaXRlci5mbHVzaChjb2RlLnBhcnNlKTtcbn07XG5cbnR5cGUgVmFsdWVNYXBwZXIgPSAocGFyYW06IGFueSwgaW5kZXg6IG51bWJlcikgPT4gYW55O1xuXG50eXBlIEJpbmRPcHRzID0ge1xuICAgIHBvcnRhbD86IHN0cmluZztcbiAgICBiaW5hcnk/OiBib29sZWFuO1xuICAgIHN0YXRlbWVudD86IHN0cmluZztcbiAgICB2YWx1ZXM/OiBhbnlbXTtcbiAgICAvLyBvcHRpb25hbCBtYXAgZnJvbSBKUyB2YWx1ZSB0byBwb3N0Z3JlcyB2YWx1ZSBwZXIgcGFyYW1ldGVyXG4gICAgdmFsdWVNYXBwZXI/OiBWYWx1ZU1hcHBlcjtcbn07XG5cbmNvbnN0IHBhcmFtV3JpdGVyID0gbmV3IFdyaXRlcigpO1xuXG4vLyBtYWtlIHRoaXMgYSBjb25zdCBlbnVtIHNvIHR5cGVzY3JpcHQgd2lsbCBpbmxpbmUgdGhlIHZhbHVlXG5jb25zdCBlbnVtIFBhcmFtVHlwZSB7XG4gICAgU1RSSU5HID0gMCxcbiAgICBCSU5BUlkgPSAxXG59XG5cbmNvbnN0IHdyaXRlVmFsdWVzID0gZnVuY3Rpb24gKHZhbHVlczogYW55W10sIHZhbHVlTWFwcGVyPzogVmFsdWVNYXBwZXIpOiB2b2lkIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBtYXBwZWRWYWwgPSB2YWx1ZU1hcHBlciA/IHZhbHVlTWFwcGVyKHZhbHVlc1tpXSwgaSkgOiB2YWx1ZXNbaV07XG4gICAgICAgIGlmIChtYXBwZWRWYWwgPT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gYWRkIHRoZSBwYXJhbSB0eXBlIChzdHJpbmcpIHRvIHRoZSB3cml0ZXJcbiAgICAgICAgICAgIHdyaXRlci5hZGRJbnQxNihQYXJhbVR5cGUuU1RSSU5HKTtcbiAgICAgICAgICAgIC8vIHdyaXRlIC0xIHRvIHRoZSBwYXJhbSB3cml0ZXIgdG8gaW5kaWNhdGUgbnVsbFxuICAgICAgICAgICAgcGFyYW1Xcml0ZXIuYWRkSW50MzIoLTEpO1xuICAgICAgICB9IGVsc2UgaWYgKG1hcHBlZFZhbCBpbnN0YW5jZW9mIEJ1ZmZlcikge1xuICAgICAgICAgICAgLy8gYWRkIHRoZSBwYXJhbSB0eXBlIChiaW5hcnkpIHRvIHRoZSB3cml0ZXJcbiAgICAgICAgICAgIHdyaXRlci5hZGRJbnQxNihQYXJhbVR5cGUuQklOQVJZKTtcbiAgICAgICAgICAgIC8vIGFkZCB0aGUgYnVmZmVyIHRvIHRoZSBwYXJhbSB3cml0ZXJcbiAgICAgICAgICAgIHBhcmFtV3JpdGVyLmFkZEludDMyKG1hcHBlZFZhbC5sZW5ndGgpO1xuICAgICAgICAgICAgcGFyYW1Xcml0ZXIuYWRkKG1hcHBlZFZhbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBhZGQgdGhlIHBhcmFtIHR5cGUgKHN0cmluZykgdG8gdGhlIHdyaXRlclxuICAgICAgICAgICAgd3JpdGVyLmFkZEludDE2KFBhcmFtVHlwZS5TVFJJTkcpO1xuICAgICAgICAgICAgcGFyYW1Xcml0ZXIuYWRkSW50MzIoQnVmZmVyLmJ5dGVMZW5ndGgobWFwcGVkVmFsKSk7XG4gICAgICAgICAgICBwYXJhbVdyaXRlci5hZGRTdHJpbmcobWFwcGVkVmFsKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbmNvbnN0IGJpbmQgPSAoY29uZmlnOiBCaW5kT3B0cyA9IHt9KTogQnVmZmVyID0+IHtcbiAgICAvLyBub3JtYWxpemUgY29uZmlnXG4gICAgY29uc3QgcG9ydGFsID0gY29uZmlnLnBvcnRhbCB8fCAnJztcbiAgICBjb25zdCBzdGF0ZW1lbnQgPSBjb25maWcuc3RhdGVtZW50IHx8ICcnO1xuICAgIGNvbnN0IGJpbmFyeSA9IGNvbmZpZy5iaW5hcnkgfHwgZmFsc2U7XG4gICAgY29uc3QgdmFsdWVzID0gY29uZmlnLnZhbHVlcyB8fCBlbXB0eUFycmF5O1xuICAgIGNvbnN0IGxlbiA9IHZhbHVlcy5sZW5ndGg7XG5cbiAgICB3cml0ZXIuYWRkQ1N0cmluZyhwb3J0YWwpLmFkZENTdHJpbmcoc3RhdGVtZW50KTtcbiAgICB3cml0ZXIuYWRkSW50MTYobGVuKTtcblxuICAgIHdyaXRlVmFsdWVzKHZhbHVlcywgY29uZmlnLnZhbHVlTWFwcGVyKTtcblxuICAgIHdyaXRlci5hZGRJbnQxNihsZW4pO1xuICAgIHdyaXRlci5hZGQocGFyYW1Xcml0ZXIuZmx1c2goKSk7XG5cbiAgICAvLyBmb3JtYXQgY29kZVxuICAgIHdyaXRlci5hZGRJbnQxNihiaW5hcnkgPyBQYXJhbVR5cGUuQklOQVJZIDogUGFyYW1UeXBlLlNUUklORyk7XG4gICAgcmV0dXJuIHdyaXRlci5mbHVzaChjb2RlLmJpbmQpO1xufTtcblxudHlwZSBFeGVjT3B0cyA9IHtcbiAgICBwb3J0YWw/OiBzdHJpbmc7XG4gICAgcm93cz86IG51bWJlcjtcbn07XG5cbmNvbnN0IGVtcHR5RXhlY3V0ZSA9IEJ1ZmZlci5mcm9tKFtjb2RlLmV4ZWN1dGUsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDksIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDBdKTtcblxuY29uc3QgZXhlY3V0ZSA9IChjb25maWc/OiBFeGVjT3B0cyk6IEJ1ZmZlciA9PiB7XG4gICAgLy8gdGhpcyBpcyB0aGUgaGFwcHkgcGF0aCBmb3IgbW9zdCBxdWVyaWVzXG4gICAgaWYgKCFjb25maWcgfHwgKCFjb25maWcucG9ydGFsICYmICFjb25maWcucm93cykpIHtcbiAgICAgICAgcmV0dXJuIGVtcHR5RXhlY3V0ZTtcbiAgICB9XG5cbiAgICBjb25zdCBwb3J0YWwgPSBjb25maWcucG9ydGFsIHx8ICcnO1xuICAgIGNvbnN0IHJvd3MgPSBjb25maWcucm93cyB8fCAwO1xuXG4gICAgY29uc3QgcG9ydGFsTGVuZ3RoID0gQnVmZmVyLmJ5dGVMZW5ndGgocG9ydGFsKTtcbiAgICBjb25zdCBsZW4gPSA0ICsgcG9ydGFsTGVuZ3RoICsgMSArIDQ7XG4gICAgLy8gb25lIGV4dHJhIGJpdCBmb3IgY29kZVxuICAgIGNvbnN0IGJ1ZmYgPSBCdWZmZXIuYWxsb2NVbnNhZmUoMSArIGxlbik7XG4gICAgYnVmZlswXSA9IGNvZGUuZXhlY3V0ZTtcbiAgICBidWZmLndyaXRlSW50MzJCRShsZW4sIDEpO1xuICAgIGJ1ZmYud3JpdGUocG9ydGFsLCA1LCAndXRmLTgnKTtcbiAgICBidWZmW3BvcnRhbExlbmd0aCArIDVdID0gMDsgLy8gbnVsbCB0ZXJtaW5hdGUgcG9ydGFsIGNTdHJpbmdcbiAgICBidWZmLndyaXRlVUludDMyQkUocm93cywgYnVmZi5sZW5ndGggLSA0KTtcbiAgICByZXR1cm4gYnVmZjtcbn07XG5cbmNvbnN0IGNhbmNlbCA9IChwcm9jZXNzSUQ6IG51bWJlciwgc2VjcmV0S2V5OiBudW1iZXIpOiBCdWZmZXIgPT4ge1xuICAgIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSgxNik7XG4gICAgYnVmZmVyLndyaXRlSW50MzJCRSgxNiwgMCk7XG4gICAgYnVmZmVyLndyaXRlSW50MTZCRSgxMjM0LCA0KTtcbiAgICBidWZmZXIud3JpdGVJbnQxNkJFKDU2NzgsIDYpO1xuICAgIGJ1ZmZlci53cml0ZUludDMyQkUocHJvY2Vzc0lELCA4KTtcbiAgICBidWZmZXIud3JpdGVJbnQzMkJFKHNlY3JldEtleSwgMTIpO1xuICAgIHJldHVybiBidWZmZXI7XG59O1xuXG50eXBlIFBvcnRhbE9wdHMgPSB7XG4gICAgdHlwZTogJ1MnIHwgJ1AnO1xuICAgIG5hbWU/OiBzdHJpbmc7XG59O1xuXG5jb25zdCBjc3RyaW5nTWVzc2FnZSA9IChjb2RlOiBjb2RlLCBzdHJpbmc6IHN0cmluZyk6IEJ1ZmZlciA9PiB7XG4gICAgY29uc3Qgc3RyaW5nTGVuID0gQnVmZmVyLmJ5dGVMZW5ndGgoc3RyaW5nKTtcbiAgICBjb25zdCBsZW4gPSA0ICsgc3RyaW5nTGVuICsgMTtcbiAgICAvLyBvbmUgZXh0cmEgYml0IGZvciBjb2RlXG4gICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKDEgKyBsZW4pO1xuICAgIGJ1ZmZlclswXSA9IGNvZGU7XG4gICAgYnVmZmVyLndyaXRlSW50MzJCRShsZW4sIDEpO1xuICAgIGJ1ZmZlci53cml0ZShzdHJpbmcsIDUsICd1dGYtOCcpO1xuICAgIGJ1ZmZlcltsZW5dID0gMDsgLy8gbnVsbCB0ZXJtaW5hdGUgY1N0cmluZ1xuICAgIHJldHVybiBidWZmZXI7XG59O1xuXG5jb25zdCBlbXB0eURlc2NyaWJlUG9ydGFsID0gd3JpdGVyLmFkZENTdHJpbmcoJ1AnKS5mbHVzaChjb2RlLmRlc2NyaWJlKTtcbmNvbnN0IGVtcHR5RGVzY3JpYmVTdGF0ZW1lbnQgPSB3cml0ZXIuYWRkQ1N0cmluZygnUycpLmZsdXNoKGNvZGUuZGVzY3JpYmUpO1xuXG5jb25zdCBkZXNjcmliZSA9IChtc2c6IFBvcnRhbE9wdHMpOiBCdWZmZXIgPT4ge1xuICAgIHJldHVybiBtc2cubmFtZVxuICAgICAgICA/IGNzdHJpbmdNZXNzYWdlKGNvZGUuZGVzY3JpYmUsIGAke21zZy50eXBlfSR7bXNnLm5hbWUgfHwgJyd9YClcbiAgICAgICAgOiBtc2cudHlwZSA9PT0gJ1AnXG4gICAgICAgID8gZW1wdHlEZXNjcmliZVBvcnRhbFxuICAgICAgICA6IGVtcHR5RGVzY3JpYmVTdGF0ZW1lbnQ7XG59O1xuXG5jb25zdCBjbG9zZSA9IChtc2c6IFBvcnRhbE9wdHMpOiBCdWZmZXIgPT4ge1xuICAgIGNvbnN0IHRleHQgPSBgJHttc2cudHlwZX0ke21zZy5uYW1lIHx8ICcnfWA7XG4gICAgcmV0dXJuIGNzdHJpbmdNZXNzYWdlKGNvZGUuY2xvc2UsIHRleHQpO1xufTtcblxuY29uc3QgY29weURhdGEgPSAoY2h1bms6IEJ1ZmZlcik6IEJ1ZmZlciA9PiB7XG4gICAgcmV0dXJuIHdyaXRlci5hZGQoY2h1bmspLmZsdXNoKGNvZGUuY29weUZyb21DaHVuayk7XG59O1xuXG5jb25zdCBjb3B5RmFpbCA9IChtZXNzYWdlOiBzdHJpbmcpOiBCdWZmZXIgPT4ge1xuICAgIHJldHVybiBjc3RyaW5nTWVzc2FnZShjb2RlLmNvcHlGYWlsLCBtZXNzYWdlKTtcbn07XG5cbmNvbnN0IGNvZGVPbmx5QnVmZmVyID0gKGNvZGU6IGNvZGUpOiBCdWZmZXIgPT4gQnVmZmVyLmZyb20oW2NvZGUsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDRdKTtcblxuY29uc3QgZmx1c2hCdWZmZXIgPSBjb2RlT25seUJ1ZmZlcihjb2RlLmZsdXNoKTtcbmNvbnN0IHN5bmNCdWZmZXIgPSBjb2RlT25seUJ1ZmZlcihjb2RlLnN5bmMpO1xuY29uc3QgZW5kQnVmZmVyID0gY29kZU9ubHlCdWZmZXIoY29kZS5lbmQpO1xuY29uc3QgY29weURvbmVCdWZmZXIgPSBjb2RlT25seUJ1ZmZlcihjb2RlLmNvcHlEb25lKTtcblxuY29uc3Qgc2VyaWFsaXplID0ge1xuICAgIHN0YXJ0dXAsXG4gICAgcGFzc3dvcmQsXG4gICAgcmVxdWVzdFNzbCxcbiAgICBzZW5kU0FTTEluaXRpYWxSZXNwb25zZU1lc3NhZ2UsXG4gICAgc2VuZFNDUkFNQ2xpZW50RmluYWxNZXNzYWdlLFxuICAgIHF1ZXJ5LFxuICAgIHBhcnNlLFxuICAgIGJpbmQsXG4gICAgZXhlY3V0ZSxcbiAgICBkZXNjcmliZSxcbiAgICBjbG9zZSxcbiAgICBmbHVzaDogKCkgPT4gZmx1c2hCdWZmZXIsXG4gICAgc3luYzogKCkgPT4gc3luY0J1ZmZlcixcbiAgICBlbmQ6ICgpID0+IGVuZEJ1ZmZlcixcbiAgICBjb3B5RGF0YSxcbiAgICBjb3B5RG9uZTogKCkgPT4gY29weURvbmVCdWZmZXIsXG4gICAgY29weUZhaWwsXG4gICAgY2FuY2VsXG59O1xuXG5leHBvcnQgeyBzZXJpYWxpemUgfTtcbiJdLCJ2ZXJzaW9uIjozfQ==