{"file":"C:\\repos\\node-postgres\\packages\\pg-protocol\\src\\parser.ts","mappings":"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","names":[],"sources":["C:\\repos\\node-postgres\\packages\\pg-protocol\\src\\parser.ts"],"sourcesContent":["import { TransformOptions } from 'stream';\r\nimport {\r\n    Mode,\r\n    bindComplete,\r\n    parseComplete,\r\n    closeComplete,\r\n    noData,\r\n    portalSuspended,\r\n    copyDone,\r\n    replicationStart,\r\n    emptyQuery,\r\n    ReadyForQueryMessage,\r\n    CommandCompleteMessage,\r\n    CopyDataMessage,\r\n    CopyResponse,\r\n    NotificationResponseMessage,\r\n    RowDescriptionMessage,\r\n    ParameterDescriptionMessage,\r\n    Field,\r\n    DataRowMessage,\r\n    ParameterStatusMessage,\r\n    BackendKeyDataMessage,\r\n    DatabaseError,\r\n    BackendMessage,\r\n    MessageName,\r\n    AuthenticationMD5Password,\r\n    NoticeMessage\r\n} from './messages';\r\nimport { BufferReader } from './buffer-reader';\r\nimport { strict as assert } from 'node:assert/strict';\r\n\r\n// every message is prefixed with a single bye\r\nconst CODE_LENGTH = 1;\r\n// every message has an int32 length which includes itself but does\r\n// NOT include the code in the length\r\nconst LEN_LENGTH = 4;\r\n\r\nconst HEADER_LENGTH = CODE_LENGTH + LEN_LENGTH;\r\n\r\nexport type Packet = {\r\n    code: number;\r\n    packet: Buffer;\r\n};\r\n\r\nconst emptyBuffer = Buffer.allocUnsafe(0);\r\n\r\ntype StreamOptions = TransformOptions & {\r\n    mode: Mode;\r\n};\r\n\r\nconst enum MessageCodes {\r\n    DataRow = 0x44, // D\r\n    ParseComplete = 0x31, // 1\r\n    BindComplete = 0x32, // 2\r\n    CloseComplete = 0x33, // 3\r\n    CommandComplete = 0x43, // C\r\n    ReadyForQuery = 0x5a, // Z\r\n    NoData = 0x6e, // n\r\n    NotificationResponse = 0x41, // A\r\n    AuthenticationResponse = 0x52, // R\r\n    ParameterStatus = 0x53, // S\r\n    BackendKeyData = 0x4b, // K\r\n    ErrorMessage = 0x45, // E\r\n    NoticeMessage = 0x4e, // N\r\n    RowDescriptionMessage = 0x54, // T\r\n    ParameterDescriptionMessage = 0x74, // t\r\n    PortalSuspended = 0x73, // s\r\n    ReplicationStart = 0x57, // W\r\n    EmptyQuery = 0x49, // I\r\n    CopyIn = 0x47, // G\r\n    CopyOut = 0x48, // H\r\n    CopyDone = 0x63, // c\r\n    CopyData = 0x64 // d\r\n}\r\n\r\nexport type MessageCallback = (msg: BackendMessage) => void;\r\n\r\nexport class Parser {\r\n    private buffer: Buffer = emptyBuffer;\r\n    private bufferLength: number = 0;\r\n    private bufferOffset: number = 0;\r\n    private reader = new BufferReader();\r\n    //private mode: Mode;\r\n\r\n    // so far the \"index.ts\" calls the constructor without arguments\r\n    constructor(opts?: StreamOptions) {\r\n        if (opts?.mode === 'binary') {\r\n            throw new Error('Binary mode not supported yet');\r\n        }\r\n        //this.mode = opts?.mode || 'text';\r\n    }\r\n\r\n    public parse(buffer: Buffer, callback: MessageCallback) {\r\n        this.mergeBuffer(buffer);\r\n        const bufferFullLength = this.bufferOffset + this.bufferLength;\r\n        let offset = this.bufferOffset;\r\n        while (offset + HEADER_LENGTH <= bufferFullLength) {\r\n            // code is 1 byte long - it identifies the message type\r\n            const code = this.buffer[offset];\r\n            // length is 1 Uint32BE - it is the length of the message EXCLUDING the code\r\n            const length = this.buffer.readUInt32BE(offset + CODE_LENGTH);\r\n            const fullMessageLength = CODE_LENGTH + length;\r\n            if (fullMessageLength + offset <= bufferFullLength) {\r\n                const message = this.handlePacket(offset + HEADER_LENGTH, code, length, this.buffer);\r\n                callback(message);\r\n                offset += fullMessageLength;\r\n            } else {\r\n                break;\r\n            }\r\n        }\r\n        if (offset === bufferFullLength) {\r\n            // No more use for the buffer\r\n            this.buffer = emptyBuffer;\r\n            this.bufferLength = 0;\r\n            this.bufferOffset = 0;\r\n        } else {\r\n            // Adjust the cursors of remainingBuffer\r\n            this.bufferLength = bufferFullLength - offset;\r\n            this.bufferOffset = offset;\r\n        }\r\n    }\r\n\r\n    private mergeBuffer(buffer: Buffer): void {\r\n        if (this.bufferLength > 0) {\r\n            const newLength = this.bufferLength + buffer.byteLength;\r\n            const newFullLength = newLength + this.bufferOffset;\r\n            if (newFullLength > this.buffer.byteLength) {\r\n                // We can't concat the new buffer with the remaining one\r\n                let newBuffer: Buffer;\r\n                if (newLength <= this.buffer.byteLength && this.bufferOffset >= this.bufferLength) {\r\n                    // We can move the relevant part to the beginning of the buffer instead of allocating a new buffer\r\n                    newBuffer = this.buffer;\r\n                } else {\r\n                    // Allocate a new larger buffer\r\n                    let newBufferLength = this.buffer.byteLength * 2;\r\n                    while (newLength >= newBufferLength) {\r\n                        newBufferLength *= 2;\r\n                    }\r\n                    newBuffer = Buffer.allocUnsafe(newBufferLength);\r\n                }\r\n                // Move the remaining buffer to the new one\r\n                this.buffer.copy(newBuffer, 0, this.bufferOffset, this.bufferOffset + this.bufferLength);\r\n                this.buffer = newBuffer;\r\n                this.bufferOffset = 0;\r\n            }\r\n            // Concat the new buffer with the remaining one\r\n            buffer.copy(this.buffer, this.bufferOffset + this.bufferLength);\r\n            this.bufferLength = newLength;\r\n        } else {\r\n            this.buffer = buffer;\r\n            this.bufferOffset = 0;\r\n            this.bufferLength = buffer.byteLength;\r\n        }\r\n    }\r\n\r\n    private handlePacket(offset: number, code: number, length: number, bytes: Buffer): BackendMessage {\r\n        switch (code) {\r\n            case MessageCodes.BindComplete:\r\n                return bindComplete;\r\n            case MessageCodes.ParseComplete:\r\n                return parseComplete;\r\n            case MessageCodes.CloseComplete:\r\n                return closeComplete;\r\n            case MessageCodes.NoData:\r\n                return noData;\r\n            case MessageCodes.PortalSuspended:\r\n                return portalSuspended;\r\n            case MessageCodes.CopyDone:\r\n                return copyDone;\r\n            case MessageCodes.ReplicationStart:\r\n                return replicationStart;\r\n            case MessageCodes.EmptyQuery:\r\n                return emptyQuery;\r\n            case MessageCodes.DataRow:\r\n                return this.parseDataRowMessage(offset, length, bytes);\r\n            case MessageCodes.CommandComplete:\r\n                return this.parseCommandCompleteMessage(offset, length, bytes);\r\n            case MessageCodes.ReadyForQuery:\r\n                return this.parseReadyForQueryMessage(offset, length, bytes);\r\n            case MessageCodes.NotificationResponse:\r\n                return this.parseNotificationMessage(offset, length, bytes);\r\n            case MessageCodes.AuthenticationResponse:\r\n                return this.parseAuthenticationResponse(offset, length, bytes);\r\n            case MessageCodes.ParameterStatus:\r\n                return this.parseParameterStatusMessage(offset, length, bytes);\r\n            case MessageCodes.BackendKeyData:\r\n                return this.parseBackendKeyData(offset, length, bytes);\r\n            case MessageCodes.ErrorMessage:\r\n                return this.parseErrorMessage(offset, length, bytes, 'error');\r\n            case MessageCodes.NoticeMessage:\r\n                return this.parseErrorMessage(offset, length, bytes, 'notice');\r\n            case MessageCodes.RowDescriptionMessage:\r\n                return this.parseRowDescriptionMessage(offset, length, bytes);\r\n            case MessageCodes.ParameterDescriptionMessage:\r\n                return this.parseParameterDescriptionMessage(offset, length, bytes);\r\n            case MessageCodes.CopyIn:\r\n                return this.parseCopyInMessage(offset, length, bytes);\r\n            case MessageCodes.CopyOut:\r\n                return this.parseCopyOutMessage(offset, length, bytes);\r\n            case MessageCodes.CopyData:\r\n                return this.parseCopyData(offset, length, bytes);\r\n            default:\r\n                assert.fail(`unknown message code: ${code.toString(16)}`);\r\n        }\r\n    }\r\n\r\n    private parseReadyForQueryMessage(offset: number, length: number, bytes: Buffer) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const status = this.reader.string(1);\r\n        return new ReadyForQueryMessage(length, status);\r\n    }\r\n\r\n    private parseCommandCompleteMessage(offset: number, length: number, bytes: Buffer) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const text = this.reader.cstring();\r\n        return new CommandCompleteMessage(length, text);\r\n    }\r\n\r\n    private parseCopyData(offset: number, length: number, bytes: Buffer) {\r\n        const chunk = bytes.slice(offset, offset + (length - 4));\r\n        return new CopyDataMessage(length, chunk);\r\n    }\r\n\r\n    private parseCopyInMessage(offset: number, length: number, bytes: Buffer) {\r\n        return this.parseCopyMessage(offset, length, bytes, 'copyInResponse');\r\n    }\r\n\r\n    private parseCopyOutMessage(offset: number, length: number, bytes: Buffer) {\r\n        return this.parseCopyMessage(offset, length, bytes, 'copyOutResponse');\r\n    }\r\n\r\n    private parseCopyMessage(offset: number, length: number, bytes: Buffer, messageName: MessageName) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const isBinary = this.reader.byte() !== 0;\r\n        const columnCount = this.reader.int16();\r\n        const message = new CopyResponse(length, messageName, isBinary, columnCount);\r\n        for (let i = 0; i < columnCount; i++) {\r\n            message.columnTypes[i] = this.reader.int16();\r\n        }\r\n        return message;\r\n    }\r\n\r\n    private parseNotificationMessage(offset: number, length: number, bytes: Buffer) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const processId = this.reader.int32();\r\n        const channel = this.reader.cstring();\r\n        const payload = this.reader.cstring();\r\n        return new NotificationResponseMessage(length, processId, channel, payload);\r\n    }\r\n\r\n    private parseRowDescriptionMessage(offset: number, length: number, bytes: Buffer) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const fieldCount = this.reader.int16();\r\n        const message = new RowDescriptionMessage(length, fieldCount);\r\n        for (let i = 0; i < fieldCount; i++) {\r\n            message.fields[i] = this.parseField();\r\n        }\r\n        return message;\r\n    }\r\n\r\n    private parseField(): Field {\r\n        const name = this.reader.cstring();\r\n        const tableID = this.reader.int32();\r\n        const columnID = this.reader.int16();\r\n        const dataTypeID = this.reader.int32();\r\n        const dataTypeSize = this.reader.int16();\r\n        const dataTypeModifier = this.reader.int32();\r\n        const mode = this.reader.int16() === 0 ? 'text' : 'binary';\r\n        return new Field(name, tableID, columnID, dataTypeID, dataTypeSize, dataTypeModifier, mode);\r\n    }\r\n\r\n    private parseParameterDescriptionMessage(offset: number, length: number, bytes: Buffer) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const parameterCount = this.reader.int16();\r\n        const message = new ParameterDescriptionMessage(length, parameterCount);\r\n        for (let i = 0; i < parameterCount; i++) {\r\n            message.dataTypeIDs[i] = this.reader.int32();\r\n        }\r\n        return message;\r\n    }\r\n\r\n    private parseDataRowMessage(offset: number, length: number, bytes: Buffer) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const fieldCount = this.reader.int16();\r\n        const fields: any[] = new Array(fieldCount);\r\n        for (let i = 0; i < fieldCount; i++) {\r\n            const len = this.reader.int32();\r\n            // a -1 for length means the value of the field is null\r\n            fields[i] = len === -1 ? null : this.reader.string(len);\r\n        }\r\n        return new DataRowMessage(length, fields);\r\n    }\r\n\r\n    private parseParameterStatusMessage(offset: number, length: number, bytes: Buffer) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const name = this.reader.cstring();\r\n        const value = this.reader.cstring();\r\n        return new ParameterStatusMessage(length, name, value);\r\n    }\r\n\r\n    private parseBackendKeyData(offset: number, length: number, bytes: Buffer) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const processID = this.reader.int32();\r\n        const secretKey = this.reader.int32();\r\n        return new BackendKeyDataMessage(length, processID, secretKey);\r\n    }\r\n\r\n    public parseAuthenticationResponse(offset: number, length: number, bytes: Buffer) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const code = this.reader.int32();\r\n        // TODO(bmc): maybe better types here\r\n        const message: BackendMessage & any = {\r\n            name: 'authenticationOk',\r\n            length\r\n        };\r\n\r\n        switch (code) {\r\n            case 0: // AuthenticationOk\r\n                break;\r\n            case 3: // AuthenticationCleartextPassword\r\n                if (message.length === 8) {\r\n                    message.name = 'authenticationCleartextPassword';\r\n                }\r\n                break;\r\n            case 5: // AuthenticationMD5Password\r\n                if (message.length === 12) {\r\n                    message.name = 'authenticationMD5Password';\r\n                    const salt = this.reader.bytes(4);\r\n                    return new AuthenticationMD5Password(length, salt);\r\n                }\r\n                break;\r\n            case 10: // AuthenticationSASL\r\n                message.name = 'authenticationSASL';\r\n                message.mechanisms = [];\r\n                let mechanism: string;\r\n                do {\r\n                    mechanism = this.reader.cstring();\r\n\r\n                    if (mechanism) {\r\n                        message.mechanisms.push(mechanism);\r\n                    }\r\n                } while (mechanism);\r\n                break;\r\n            case 11: // AuthenticationSASLContinue\r\n                message.name = 'authenticationSASLContinue';\r\n                message.data = this.reader.string(length - 8);\r\n                break;\r\n            case 12: // AuthenticationSASLFinal\r\n                message.name = 'authenticationSASLFinal';\r\n                message.data = this.reader.string(length - 8);\r\n                break;\r\n            default:\r\n                throw new Error('Unknown authenticationOk message type ' + code);\r\n        }\r\n        return message;\r\n    }\r\n\r\n    private parseErrorMessage(offset: number, length: number, bytes: Buffer, name: MessageName) {\r\n        this.reader.setBuffer(offset, bytes);\r\n        const fields: Record<string, string> = {};\r\n        let fieldType = this.reader.string(1);\r\n        while (fieldType !== '\\0') {\r\n            fields[fieldType] = this.reader.cstring();\r\n            fieldType = this.reader.string(1);\r\n        }\r\n\r\n        const messageValue = fields.M;\r\n\r\n        const message =\r\n            name === 'notice' ? new NoticeMessage(length, messageValue) : new DatabaseError(messageValue, length, name);\r\n\r\n        message.severity = fields.S;\r\n        message.code = fields.C;\r\n        message.detail = fields.D;\r\n        message.hint = fields.H;\r\n        message.position = fields.P;\r\n        message.internalPosition = fields.p;\r\n        message.internalQuery = fields.q;\r\n        message.where = fields.W;\r\n        message.schema = fields.s;\r\n        message.table = fields.t;\r\n        message.column = fields.c;\r\n        message.dataType = fields.d;\r\n        message.constraint = fields.n;\r\n        message.file = fields.F;\r\n        message.line = fields.L;\r\n        message.routine = fields.R;\r\n        return message;\r\n    }\r\n}\r\n"],"version":3}